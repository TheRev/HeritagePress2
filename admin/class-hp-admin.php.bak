<?php

/**
 * HeritagePress Admin Class
 */
class HeritagePress_Admin
{

  /**
   * Single instance of class
   */
  private static $instance = null;

  /**
   * Get class instance
   */
  public static function instance()
  {
    if (is_null(self::$instance)) {
      self::$instance = new self();
    }
    return self::$instance;
  }

  /**
   * Constructor
   */
  private function __construct()
  {
    $this->init_hooks();
  }
  /**
   * Initialize hooks
   */
  private function init_hooks()
  {
    add_action('admin_init', array($this, 'init_admin'));
    add_action('admin_menu', array($this, 'add_admin_menu'));
    add_action('admin_init', array($this, 'handle_export_request'));

    // Register form handlers
    add_action('admin_post_heritagepress_add_newtree', array($this, 'handle_add_tree'));
    add_action('admin_post_heritagepress_edit_tree', array($this, 'handle_edit_tree'));
  }

  /**
   * Add admin menu items
   */
  public function add_admin_menu()
  {
    require_once dirname(__FILE__) . '/admin_trees.php';

    // Main menu: HeritagePress Dashboard
    add_menu_page(
      __('HeritagePress Dashboard', 'heritagepress'),
      __('HeritagePress', 'heritagepress'),
      'manage_options',
      'heritagepress-dashboard',
      array($this, 'render_dashboard_page'),
      'dashicons-admin-home',
      2
    );

    // Submenus
    add_submenu_page(
      'heritagepress-dashboard',
      __('Trees', 'heritagepress'),
      __('Trees', 'heritagepress'),
      'manage_options',
      'heritagepress-trees',
      array($this, 'render_trees_page')
    );
    add_submenu_page(
      'heritagepress-dashboard',
      __('People', 'heritagepress'),
      __('People', 'heritagepress'),
      'manage_options',
      'heritagepress-people',
      array($this, 'render_people_page')
    );
    add_submenu_page(
      'heritagepress-dashboard',
      __('Families', 'heritagepress'),
      __('Families', 'heritagepress'),
      'manage_options',
      'heritagepress-families',
      array($this, 'render_families_page')
    );
    add_submenu_page(
      'heritagepress-dashboard',
      __('Media', 'heritagepress'),
      __('Media', 'heritagepress'),
      'manage_options',
      'heritagepress-media',
      array($this, 'render_media_page')
    );
    add_submenu_page(
      'heritagepress-dashboard',
      __('Sources', 'heritagepress'),
      __('Sources', 'heritagepress'),
      'manage_options',
      'heritagepress-sources',
      array($this, 'render_sources_page')
    );
    add_submenu_page(
      'heritagepress-dashboard',
      __('Repositories', 'heritagepress'),
      __('Repositories', 'heritagepress'),
      'manage_options',
      'heritagepress-repositories',
      array($this, 'render_repositories_page')
    );
    add_submenu_page(
      'heritagepress-dashboard',
      __('Import / Export', 'heritagepress'),
      __('Import / Export', 'heritagepress'),
      'manage_options',
      'heritagepress-import-export',
      array($this, 'render_import_export_page')
    );
    add_submenu_page(
      'heritagepress-dashboard',
      __('Review Data', 'heritagepress'),
      __('Review Data', 'heritagepress'),
      'manage_options',
      'heritagepress-review',
      array($this, 'render_review_page')
    );
    add_submenu_page(
      'heritagepress-dashboard',
      __('Users', 'heritagepress'),
      __('Users', 'heritagepress'),
      'manage_options',
      'heritagepress-users',
      array($this, 'render_users_page')
    );
    add_submenu_page(
      'heritagepress-dashboard',
      __('Global Configuration', 'heritagepress'),
      __('Global Configuration', 'heritagepress'),
      'manage_options',
      'heritagepress-config',
      array($this, 'render_config_page')
    );
    add_submenu_page(
      null, // Hidden from menu, direct access only
      __('Edit Tree', 'heritagepress'),
      __('Edit Tree', 'heritagepress'),
      'manage_options',
      'heritagepress-edittree',
      array($this, 'render_edit_tree_page')
    );
  }

  // Renderers for each submenu (to be implemented or linked to controllers)
  public function render_trees_page()
  {
    if (function_exists('heritagepress_admin_trees_page')) {
      heritagepress_admin_trees_page();
    } else {
      echo '<div class="notice notice-error"><p>Trees admin page function not found.</p></div>';
    }
  }
  public function render_people_page()
  {
    if (class_exists('HP_People_Controller')) {
      (new HP_People_Controller())->display_page();
    } else {
      echo '<div class="notice notice-error"><p>People controller not found.</p></div>';
    }
  }
  public function render_families_page()
  {
    if (class_exists('HP_Families_Controller')) {
      (new HP_Families_Controller())->display_page();
    } else {
      echo '<h2>Families</h2><p>Families management coming soon.</p>';
    }
  }
  public function render_media_page()
  {
    if (class_exists('HP_Media_Controller')) {
      (new HP_Media_Controller())->display_page();
    } else {
      echo '<h2>Media</h2><p>Media management coming soon.</p>';
    }
  }
  public function render_sources_page()
  {
    if (class_exists('HP_Source_Controller')) {
      (new HP_Source_Controller())->display_page();
    } else {
      echo '<h2>Sources</h2><p>Sources management coming soon.</p>';
    }
  }
  public function render_repositories_page()
  {
    if (class_exists('HP_Repository_Controller')) {
      (new HP_Repository_Controller())->display_page();
    } else {
      echo '<h2>Repositories</h2><p>Repositories management coming soon.</p>';
    }
  }
  public function render_dashboard_page()
  {
    echo '<div class="wrap">';
    echo '<style>
      .hp-dashboard-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      .hp-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }
      .hp-stat-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
      }
      .hp-stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      }
      .hp-stat-number {
        font-size: 2.5em;
        font-weight: bold;
        color: #667eea;
        margin: 0;
      }
      .hp-stat-label {
        color: #666;
        margin: 5px 0 0 0;
        font-size: 1.1em;
      }
      .hp-menu-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
        margin-top: 20px;
      }
      .hp-menu-section {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .hp-menu-section h3 {
        color: #667eea;
        margin-top: 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
      }
      .hp-menu-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .hp-menu-list li {
        margin: 10px 0;
      }
      .hp-menu-list a {
        display: block;
        padding: 10px 15px;
        text-decoration: none;
        color: #333;
        background: #f9f9f9;
        border-radius: 5px;
        transition: all 0.2s ease;
      }
      .hp-menu-list a:hover {
        background: #667eea;
        color: white;
        transform: translateX(5px);
      }
    </style>';

    echo '<div class="hp-dashboard-header">';
    echo '<h1 style="margin: 0; font-size: 2.5em;">HeritagePress Dashboard</h1>';
    echo '<p style="margin: 10px 0 0 0; font-size: 1.2em; opacity: 0.9;">Your complete genealogy management solution</p>';
    echo '</div>';

    // Statistics Cards
    echo '<div class="hp-stats-grid">';

    // Fetch real statistics from the database
    $stats = $this->get_dashboard_stats();
    echo '<div class="hp-stat-card">';
    echo '<h2 class="hp-stat-number">' . number_format($stats['trees']) . '</h2>';
    echo '<p class="hp-stat-label">Family Trees</p>';
    echo '</div>';
    echo '<div class="hp-stat-card">';
    echo '<h2 class="hp-stat-number">' . number_format($stats['people']) . '</h2>';
    echo '<p class="hp-stat-label">People Records</p>';
    echo '</div>';
    echo '<div class="hp-stat-card">';
    echo '<h2 class="hp-stat-number">' . number_format($stats['families']) . '</h2>';
    echo '<p class="hp-stat-label">Family Records</p>';
    echo '</div>';
    echo '<div class="hp-stat-card">';
    echo '<h2 class="hp-stat-number">' . number_format($stats['media']) . '</h2>';
    echo '<p class="hp-stat-label">Media Files</p>';
    echo '</div>';
    echo '<div class="hp-stat-card">';
    echo '<h2 class="hp-stat-number">' . number_format($stats['sources']) . '</h2>';
    echo '<p class="hp-stat-label">Source Citations</p>';
    echo '</div>';
    echo '<div class="hp-stat-card">';
    echo '<h2 class="hp-stat-number">' . number_format($stats['repositories']) . '</h2>';
    echo '<p class="hp-stat-label">Repositories</p>';
    echo '</div>';
    echo '</div>';

    // Menu Sections
    echo '<div class="hp-menu-grid">';

    // Core Management
    echo '<div class="hp-menu-section">';
    echo '<h3>ğŸ“Š Core Management</h3>';
    echo '<ul class="hp-menu-list">';
    echo '<li><a href="admin.php?page=heritagepress-trees">ğŸŒ³ Manage Trees</a></li>';
    echo '<li><a href="admin.php?page=heritagepress-people">ğŸ‘¥ Manage People</a></li>';
    echo '<li><a href="admin.php?page=heritagepress-families">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Manage Families</a></li>';
    echo '</ul>';
    echo '</div>';

    // Media & Documentation
    echo '<div class="hp-menu-section">';
    echo '<h3>ğŸ“š Media & Documentation</h3>';
    echo '<ul class="hp-menu-list">';
    echo '<li><a href="admin.php?page=heritagepress-media">ğŸ–¼ï¸ Manage Media</a></li>';
    echo '<li><a href="admin.php?page=heritagepress-sources">ğŸ“„ Manage Sources</a></li>';
    echo '<li><a href="admin.php?page=heritagepress-repositories">ğŸ›ï¸ Manage Repositories</a></li>';
    echo '</ul>';
    echo '</div>';

    // Data Management
    echo '<div class="hp-menu-section">';
    echo '<h3>ğŸ”„ Data Management</h3>';
    echo '<ul class="hp-menu-list">';
    echo '<li><a href="admin.php?page=heritagepress-import-export">ğŸ“¥ğŸ“¤ Import / Export</a></li>';
    echo '<li><a href="admin.php?page=heritagepress-validation">âœ… Data Validation</a></li>';
    echo '<li><a href="admin.php?page=heritagepress-backup">ğŸ’¾ Backup & Restore</a></li>';
    echo '</ul>';
    echo '</div>';

    // Tools & Utilities
    echo '<div class="hp-menu-section">';
    echo '<h3>ğŸ› ï¸ Tools & Utilities</h3>';
    echo '<ul class="hp-menu-list">';
    echo '<li><a href="admin.php?page=heritagepress-reports">ğŸ“Š Reports</a></li>';
    echo '<li><a href="admin.php?page=heritagepress-id-checker">ğŸ” ID Checker</a></li>';
    echo '<li><a href="admin.php?page=heritagepress-maintenance">âš™ï¸ Maintenance</a></li>';
    echo '</ul>';
    echo '</div>';

    // Settings & Configuration
    echo '<div class="hp-menu-section">';
    echo '<h3>âš™ï¸ Settings & Configuration</h3>';
    echo '<ul class="hp-menu-list">';
    echo '<li><a href="admin.php?page=heritagepress-languages">ğŸŒ Languages</a></li>';
    echo '<li><a href="admin.php?page=heritagepress-custom-text">ğŸ“ Custom Text</a></li>';
    echo '<li><a href="admin.php?page=heritagepress-settings">âš™ï¸ Plugin Settings</a></li>';
    echo '</ul>';
    echo '</div>';

    // Recent Activity
    echo '<div class="hp-menu-section">';
    echo '<h3>ğŸ“ˆ Recent Activity</h3>';
    echo '<ul class="hp-menu-list" style="font-size: 0.9em;">';
    echo '<li style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">âœ… GEDCOM import completed (2 hours ago)</li>';
    echo '<li style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">ğŸ‘¤ John Smith added to Miller family tree (4 hours ago)</li>';
    echo '<li style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">ğŸ“¸ 3 photos uploaded to media library (1 day ago)</li>';
    echo '<li style="padding: 5px 0;">ğŸ”„ Database backup completed successfully (2 days ago)</li>';
    echo '</ul>';
    echo '</div>';

    echo '</div>'; // End menu grid
    echo '</div>'; // End wrap
  }
  public function render_import_export_page()
  {
    // Use the tabbed UI template for import/export/post-import
    include_once HERITAGEPRESS_PLUGIN_DIR . 'includes/template/admin/import/import-export-split.php';
  }
  public function render_review_page()
  {
    include_once dirname(__FILE__) . '/views/review-management.php';
  }
  public function render_users_page()
  {
    if (class_exists('HP_User_Controller')) {
      (new HP_User_Controller())->display_page();
    } else {
      echo '<div class="notice notice-error"><p>Users controller not found.</p></div>';
    }
  }
  public function render_config_page()
  {
    if (class_exists('HeritagePress_Config_Controller')) {
      (new HeritagePress_Config_Controller())->display_page();
    } else {
      echo '<div class="notice notice-error"><p>Config controller not found.</p></div>';
    }
  }
  public function render_edit_tree_page()
  {
    if (!current_user_can('manage_options')) {
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }
    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    $tree_id = isset($_GET['tree']) ? sanitize_text_field($_GET['tree']) : '';
    if (empty($tree_id)) {
      echo '<div class="notice notice-error"><p>' . esc_html__('No tree specified.', 'heritagepress') . '</p></div>';
      return;
    }
    $tree = $wpdb->get_row($wpdb->prepare("SELECT * FROM $trees_table WHERE gedcom = %s", $tree_id), ARRAY_A);
    if (!$tree) {
      echo '<div class="notice notice-error"><p>' . esc_html__('Tree not found.', 'heritagepress') . '</p></div>';
      return;
    }
    $nonce = wp_create_nonce('heritagepress_edittree');
    echo '<div class="wrap">';
    echo '<h1>' . esc_html__('Edit Tree', 'heritagepress') . ': ' . esc_html($tree['gedcom']) . '</h1>';
    echo '<form action="' . esc_url(admin_url('admin-post.php')) . '" method="post">';
    echo '<input type="hidden" name="action" value="heritagepress_edit_tree">';
    echo '<input type="hidden" name="_wpnonce" value="' . esc_attr($nonce) . '">';
    echo '<input type="hidden" name="original_tree_id" value="' . esc_attr($tree['gedcom']) . '">';
    echo '<table class="form-table">';
    echo '<tr><th><label for="tree_id">' . esc_html__('Tree ID', 'heritagepress') . '</label></th>';
    echo '<td><input type="text" name="tree_id" id="tree_id" value="' . esc_attr($tree['gedcom']) . '" class="regular-text" maxlength="20" required></td></tr>';
    echo '<tr><th><label for="tree_name">' . esc_html__('Tree Name', 'heritagepress') . '</label></th>';
    echo '<td><input type="text" name="tree_name" id="tree_name" value="' . esc_attr($tree['treename']) . '" class="regular-text" required></td></tr>';
    echo '<tr><th><label for="description">' . esc_html__('Description', 'heritagepress') . '</label></th>';
    echo '<td><textarea name="description" id="description" rows="3" cols="40">' . esc_textarea($tree['description']) . '</textarea></td></tr>';
    echo '<tr><th><label for="owner">' . esc_html__('Owner', 'heritagepress') . '</label></th>';
    echo '<td><input type="text" name="owner" id="owner" value="' . esc_attr($tree['owner']) . '" class="regular-text"></td></tr>';
    echo '<tr><th><label for="email">' . esc_html__('Email', 'heritagepress') . '</label></th>';
    echo '<td><input type="email" name="email" id="email" value="' . esc_attr($tree['email']) . '" class="regular-text"></td></tr>';
    echo '<tr><th><label for="address">' . esc_html__('Address', 'heritagepress') . '</label></th>';
    echo '<td><input type="text" name="address" id="address" value="' . esc_attr($tree['address']) . '" class="regular-text"></td></tr>';
    echo '<tr><th><label for="city">' . esc_html__('City', 'heritagepress') . '</label></th>';
    echo '<td><input type="text" name="city" id="city" value="' . esc_attr($tree['city']) . '" class="regular-text"></td></tr>';
    echo '<tr><th><label for="state">' . esc_html__('State/Province', 'heritagepress') . '</label></th>';
    echo '<td><input type="text" name="state" id="state" value="' . esc_attr($tree['state']) . '" class="regular-text"></td></tr>';
    echo '<tr><th><label for="zip">' . esc_html__('Zip', 'heritagepress') . '</label></th>';
    echo '<td><input type="text" name="zip" id="zip" value="' . esc_attr($tree['zip']) . '" class="regular-text"></td></tr>';
    echo '<tr><th><label for="country">' . esc_html__('Country', 'heritagepress') . '</label></th>';
    echo '<td><input type="text" name="country" id="country" value="' . esc_attr($tree['country']) . '" class="regular-text"></td></tr>';
    echo '<tr><th><label for="phone">' . esc_html__('Phone', 'heritagepress') . '</label></th>';
    echo '<td><input type="text" name="phone" id="phone" value="' . esc_attr($tree['phone']) . '" class="regular-text"></td></tr>';
    echo '<tr><th><label for="private">' . esc_html__('Keep Owner/Contact Info Private', 'heritagepress') . '</label></th>';
    echo '<td><input type="checkbox" name="private" id="private" value="1"' . ($tree['secret'] ? ' checked' : '') . '></td></tr>';
    echo '<tr><th><label for="disallowgedcreate">' . esc_html__('Disallow GEDCOM Download', 'heritagepress') . '</label></th>';
    echo '<td><input type="checkbox" name="disallowgedcreate" id="disallowgedcreate" value="1"' . ($tree['disallowgedcreate'] ? ' checked' : '') . '></td></tr>';
    echo '<tr><th><label for="disallowpdf">' . esc_html__('Disallow PDF Generation', 'heritagepress') . '</label></th>';
    echo '<td><input type="checkbox" name="disallowpdf" id="disallowpdf" value="1"' . ($tree['disallowpdf'] ? ' checked' : '') . '></td></tr>';
    echo '</table>';
    echo '<p class="submit">';
    echo '<input type="submit" class="button-primary" value="' . esc_attr__('Save Changes', 'heritagepress') . '"> ';
    echo '<a href="' . esc_url(admin_url('admin.php?page=heritagepress-trees&tab=browse')) . '" class="button">' . esc_html__('Cancel', 'heritagepress') . '</a>';
    echo '</p>';
    echo '</form>';
    echo '</div>';
  }

  /**
   * Initialize admin
   */
  public function init_admin()
  {
    // Load admin dependencies
    $this->load_files();

    // Initialize controllers
    $this->init_controllers();
  }

  /**
   * Load required files
   */
  private function load_files()
  {
    // Load controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-people-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-import-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-export-controller.php';    // Load admin controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-admin-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-branch-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-endpoint.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-entity-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-media-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-source-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-repository-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-user-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-config-controller.php';
    require_once dirname(__FILE__) . '/controllers/class-hp-families-controller.php';

    // Load handlers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-ajax-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-form-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/handlers/class-hp-add-tree-handler.php';
  }

  /**
   * Initialize controllers
   */
  private function init_controllers()
  {
    new HP_People_Controller();
    new HP_Trees_Controller();
    new HP_Import_Controller();
  }

  /**
   * Handle export request
   */
  public function handle_export_request()
  {
    $export_controller = new HP_Export_Controller();
    $export_controller->handle_export_request();
  }

  /**
   * Handle add tree form submission
   */
  public function handle_add_tree()
  {
    error_log("=== HeritagePress Add Tree Handler Called (Class Method) ===");
    error_log("POST data: " . print_r($_POST, true));

    if (!current_user_can('manage_options')) {
      error_log("Permission check failed");
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }

    check_admin_referer('heritagepress_newtree');
    error_log("Nonce check passed");

    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    error_log("Using table: $trees_table");

    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;

    error_log("Parsed data - tree_id: $tree_id, tree_name: $tree_name");

    if (empty($tree_id) || empty($tree_name)) {
      error_log("Validation failed - empty tree_id or tree_name");
      wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=add&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }

    // Insert new tree
    $insert_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf,
      'lastimportdate' => '1970-01-01 00:00:00',
      'importfilename' => '',
    ];

    error_log("Insert data: " . print_r($insert_data, true));

    $result = $wpdb->insert($trees_table, $insert_data);
    error_log("Insert result: " . ($result === false ? 'FALSE' : $result));

    if ($result === false) {
      $error = $wpdb->last_error;
      error_log('HeritagePress Add Tree DB Error: ' . $error);
      error_log('Last query: ' . $wpdb->last_query);
      wp_die('Database error: ' . esc_html($error));
    }

    error_log("Insert successful, redirecting...");
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree added successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Handle edit tree form submission
   */
  public function handle_edit_tree()
  {
    if (!current_user_can('manage_options')) {
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }
    check_admin_referer('heritagepress_edittree');
    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    $original_tree_id = isset($_POST['original_tree_id']) ? sanitize_text_field($_POST['original_tree_id']) : '';
    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;
    if (empty($tree_id) || empty($tree_name)) {
      wp_redirect(admin_url('admin.php?page=heritagepress-edittree&tree=' . urlencode($original_tree_id) . '&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }
    $update_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf
    ];
    $result = $wpdb->update($trees_table, $update_data, ['gedcom' => $original_tree_id]);
    if ($result === false) {
      $error = $wpdb->last_error;
      wp_die('Database error: ' . esc_html($error));
    }
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree updated successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Initialize admin
   */
  public function init_admin()
  {
    // Load admin dependencies
    $this->load_files();

    // Initialize controllers
    $this->init_controllers();
  }

  /**
   * Load required files
   */
  private function load_files()
  {
    // Load controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-people-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-import-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-export-controller.php';    // Load admin controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-admin-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-branch-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-endpoint.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-entity-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-media-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-source-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-repository-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-user-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-config-controller.php';
    require_once dirname(__FILE__) . '/controllers/class-hp-families-controller.php';

    // Load handlers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-ajax-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-form-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/handlers/class-hp-add-tree-handler.php';
  }

  /**
   * Initialize controllers
   */
  private function init_controllers()
  {
    new HP_People_Controller();
    new HP_Trees_Controller();
    new HP_Import_Controller();
  }

  /**
   * Handle export request
   */
  public function handle_export_request()
  {
    $export_controller = new HP_Export_Controller();
    $export_controller->handle_export_request();
  }

  /**
   * Handle add tree form submission
   */
  public function handle_add_tree()
  {
    error_log("=== HeritagePress Add Tree Handler Called (Class Method) ===");
    error_log("POST data: " . print_r($_POST, true));

    if (!current_user_can('manage_options')) {
      error_log("Permission check failed");
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }

    check_admin_referer('heritagepress_newtree');
    error_log("Nonce check passed");

    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    error_log("Using table: $trees_table");

    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;

    error_log("Parsed data - tree_id: $tree_id, tree_name: $tree_name");

    if (empty($tree_id) || empty($tree_name)) {
      error_log("Validation failed - empty tree_id or tree_name");
      wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=add&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }

    // Insert new tree
    $insert_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf,
      'lastimportdate' => '1970-01-01 00:00:00',
      'importfilename' => '',
    ];

    error_log("Insert data: " . print_r($insert_data, true));

    $result = $wpdb->insert($trees_table, $insert_data);
    error_log("Insert result: " . ($result === false ? 'FALSE' : $result));

    if ($result === false) {
      $error = $wpdb->last_error;
      error_log('HeritagePress Add Tree DB Error: ' . $error);
      error_log('Last query: ' . $wpdb->last_query);
      wp_die('Database error: ' . esc_html($error));
    }

    error_log("Insert successful, redirecting...");
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree added successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Handle edit tree form submission
   */
  public function handle_edit_tree()
  {
    if (!current_user_can('manage_options')) {
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }
    check_admin_referer('heritagepress_edittree');
    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    $original_tree_id = isset($_POST['original_tree_id']) ? sanitize_text_field($_POST['original_tree_id']) : '';
    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;
    if (empty($tree_id) || empty($tree_name)) {
      wp_redirect(admin_url('admin.php?page=heritagepress-edittree&tree=' . urlencode($original_tree_id) . '&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }
    $update_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf
    ];
    $result = $wpdb->update($trees_table, $update_data, ['gedcom' => $original_tree_id]);
    if ($result === false) {
      $error = $wpdb->last_error;
      wp_die('Database error: ' . esc_html($error));
    }
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree updated successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Initialize admin
   */
  public function init_admin()
  {
    // Load admin dependencies
    $this->load_files();

    // Initialize controllers
    $this->init_controllers();
  }

  /**
   * Load required files
   */
  private function load_files()
  {
    // Load controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-people-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-import-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-export-controller.php';    // Load admin controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-admin-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-branch-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-endpoint.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-entity-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-media-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-source-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-repository-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-user-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-config-controller.php';
    require_once dirname(__FILE__) . '/controllers/class-hp-families-controller.php';

    // Load handlers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-ajax-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-form-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/handlers/class-hp-add-tree-handler.php';
  }

  /**
   * Initialize controllers
   */
  private function init_controllers()
  {
    new HP_People_Controller();
    new HP_Trees_Controller();
    new HP_Import_Controller();
  }

  /**
   * Handle export request
   */
  public function handle_export_request()
  {
    $export_controller = new HP_Export_Controller();
    $export_controller->handle_export_request();
  }

  /**
   * Handle add tree form submission
   */
  public function handle_add_tree()
  {
    error_log("=== HeritagePress Add Tree Handler Called (Class Method) ===");
    error_log("POST data: " . print_r($_POST, true));

    if (!current_user_can('manage_options')) {
      error_log("Permission check failed");
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }

    check_admin_referer('heritagepress_newtree');
    error_log("Nonce check passed");

    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    error_log("Using table: $trees_table");

    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;

    error_log("Parsed data - tree_id: $tree_id, tree_name: $tree_name");

    if (empty($tree_id) || empty($tree_name)) {
      error_log("Validation failed - empty tree_id or tree_name");
      wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=add&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }

    // Insert new tree
    $insert_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf,
      'lastimportdate' => '1970-01-01 00:00:00',
      'importfilename' => '',
    ];

    error_log("Insert data: " . print_r($insert_data, true));

    $result = $wpdb->insert($trees_table, $insert_data);
    error_log("Insert result: " . ($result === false ? 'FALSE' : $result));

    if ($result === false) {
      $error = $wpdb->last_error;
      error_log('HeritagePress Add Tree DB Error: ' . $error);
      error_log('Last query: ' . $wpdb->last_query);
      wp_die('Database error: ' . esc_html($error));
    }

    error_log("Insert successful, redirecting...");
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree added successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Handle edit tree form submission
   */
  public function handle_edit_tree()
  {
    if (!current_user_can('manage_options')) {
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }
    check_admin_referer('heritagepress_edittree');
    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    $original_tree_id = isset($_POST['original_tree_id']) ? sanitize_text_field($_POST['original_tree_id']) : '';
    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;
    if (empty($tree_id) || empty($tree_name)) {
      wp_redirect(admin_url('admin.php?page=heritagepress-edittree&tree=' . urlencode($original_tree_id) . '&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }
    $update_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf
    ];
    $result = $wpdb->update($trees_table, $update_data, ['gedcom' => $original_tree_id]);
    if ($result === false) {
      $error = $wpdb->last_error;
      wp_die('Database error: ' . esc_html($error));
    }
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree updated successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Initialize admin
   */
  public function init_admin()
  {
    // Load admin dependencies
    $this->load_files();

    // Initialize controllers
    $this->init_controllers();
  }

  /**
   * Load required files
   */
  private function load_files()
  {
    // Load controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-people-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-import-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-export-controller.php';    // Load admin controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-admin-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-branch-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-endpoint.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-entity-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-media-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-source-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-repository-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-user-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-config-controller.php';
    require_once dirname(__FILE__) . '/controllers/class-hp-families-controller.php';

    // Load handlers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-ajax-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-form-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/handlers/class-hp-add-tree-handler.php';
  }

  /**
   * Initialize controllers
   */
  private function init_controllers()
  {
    new HP_People_Controller();
    new HP_Trees_Controller();
    new HP_Import_Controller();
  }

  /**
   * Handle export request
   */
  public function handle_export_request()
  {
    $export_controller = new HP_Export_Controller();
    $export_controller->handle_export_request();
  }

  /**
   * Handle add tree form submission
   */
  public function handle_add_tree()
  {
    error_log("=== HeritagePress Add Tree Handler Called (Class Method) ===");
    error_log("POST data: " . print_r($_POST, true));

    if (!current_user_can('manage_options')) {
      error_log("Permission check failed");
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }

    check_admin_referer('heritagepress_newtree');
    error_log("Nonce check passed");

    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    error_log("Using table: $trees_table");

    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;

    error_log("Parsed data - tree_id: $tree_id, tree_name: $tree_name");

    if (empty($tree_id) || empty($tree_name)) {
      error_log("Validation failed - empty tree_id or tree_name");
      wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=add&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }

    // Insert new tree
    $insert_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf,
      'lastimportdate' => '1970-01-01 00:00:00',
      'importfilename' => '',
    ];

    error_log("Insert data: " . print_r($insert_data, true));

    $result = $wpdb->insert($trees_table, $insert_data);
    error_log("Insert result: " . ($result === false ? 'FALSE' : $result));

    if ($result === false) {
      $error = $wpdb->last_error;
      error_log('HeritagePress Add Tree DB Error: ' . $error);
      error_log('Last query: ' . $wpdb->last_query);
      wp_die('Database error: ' . esc_html($error));
    }

    error_log("Insert successful, redirecting...");
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree added successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Handle edit tree form submission
   */
  public function handle_edit_tree()
  {
    if (!current_user_can('manage_options')) {
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }
    check_admin_referer('heritagepress_edittree');
    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    $original_tree_id = isset($_POST['original_tree_id']) ? sanitize_text_field($_POST['original_tree_id']) : '';
    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;
    if (empty($tree_id) || empty($tree_name)) {
      wp_redirect(admin_url('admin.php?page=heritagepress-edittree&tree=' . urlencode($original_tree_id) . '&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }
    $update_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf
    ];
    $result = $wpdb->update($trees_table, $update_data, ['gedcom' => $original_tree_id]);
    if ($result === false) {
      $error = $wpdb->last_error;
      wp_die('Database error: ' . esc_html($error));
    }
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree updated successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Initialize admin
   */
  public function init_admin()
  {
    // Load admin dependencies
    $this->load_files();

    // Initialize controllers
    $this->init_controllers();
  }

  /**
   * Load required files
   */
  private function load_files()
  {
    // Load controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-people-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-import-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-export-controller.php';    // Load admin controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-admin-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-branch-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-endpoint.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-entity-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-media-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-source-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-repository-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-user-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-config-controller.php';
    require_once dirname(__FILE__) . '/controllers/class-hp-families-controller.php';

    // Load handlers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-ajax-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-form-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/handlers/class-hp-add-tree-handler.php';
  }

  /**
   * Initialize controllers
   */
  private function init_controllers()
  {
    new HP_People_Controller();
    new HP_Trees_Controller();
    new HP_Import_Controller();
  }

  /**
   * Handle export request
   */
  public function handle_export_request()
  {
    $export_controller = new HP_Export_Controller();
    $export_controller->handle_export_request();
  }

  /**
   * Handle add tree form submission
   */
  public function handle_add_tree()
  {
    error_log("=== HeritagePress Add Tree Handler Called (Class Method) ===");
    error_log("POST data: " . print_r($_POST, true));

    if (!current_user_can('manage_options')) {
      error_log("Permission check failed");
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }

    check_admin_referer('heritagepress_newtree');
    error_log("Nonce check passed");

    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    error_log("Using table: $trees_table");

    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;

    error_log("Parsed data - tree_id: $tree_id, tree_name: $tree_name");

    if (empty($tree_id) || empty($tree_name)) {
      error_log("Validation failed - empty tree_id or tree_name");
      wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=add&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }

    // Insert new tree
    $insert_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf,
      'lastimportdate' => '1970-01-01 00:00:00',
      'importfilename' => '',
    ];

    error_log("Insert data: " . print_r($insert_data, true));

    $result = $wpdb->insert($trees_table, $insert_data);
    error_log("Insert result: " . ($result === false ? 'FALSE' : $result));

    if ($result === false) {
      $error = $wpdb->last_error;
      error_log('HeritagePress Add Tree DB Error: ' . $error);
      error_log('Last query: ' . $wpdb->last_query);
      wp_die('Database error: ' . esc_html($error));
    }

    error_log("Insert successful, redirecting...");
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree added successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Handle edit tree form submission
   */
  public function handle_edit_tree()
  {
    if (!current_user_can('manage_options')) {
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }
    check_admin_referer('heritagepress_edittree');
    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    $original_tree_id = isset($_POST['original_tree_id']) ? sanitize_text_field($_POST['original_tree_id']) : '';
    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;
    if (empty($tree_id) || empty($tree_name)) {
      wp_redirect(admin_url('admin.php?page=heritagepress-edittree&tree=' . urlencode($original_tree_id) . '&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }
    $update_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf
    ];
    $result = $wpdb->update($trees_table, $update_data, ['gedcom' => $original_tree_id]);
    if ($result === false) {
      $error = $wpdb->last_error;
      wp_die('Database error: ' . esc_html($error));
    }
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree updated successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Initialize admin
   */
  public function init_admin()
  {
    // Load admin dependencies
    $this->load_files();

    // Initialize controllers
    $this->init_controllers();
  }

  /**
   * Load required files
   */
  private function load_files()
  {
    // Load controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-people-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-import-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-export-controller.php';    // Load admin controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-admin-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-branch-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-endpoint.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-entity-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-media-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-source-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-repository-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-user-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-config-controller.php';
    require_once dirname(__FILE__) . '/controllers/class-hp-families-controller.php';

    // Load handlers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-ajax-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-form-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/handlers/class-hp-add-tree-handler.php';
  }

  /**
   * Initialize controllers
   */
  private function init_controllers()
  {
    new HP_People_Controller();
    new HP_Trees_Controller();
    new HP_Import_Controller();
  }

  /**
   * Handle export request
   */
  public function handle_export_request()
  {
    $export_controller = new HP_Export_Controller();
    $export_controller->handle_export_request();
  }

  /**
   * Handle add tree form submission
   */
  public function handle_add_tree()
  {
    error_log("=== HeritagePress Add Tree Handler Called (Class Method) ===");
    error_log("POST data: " . print_r($_POST, true));

    if (!current_user_can('manage_options')) {
      error_log("Permission check failed");
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }

    check_admin_referer('heritagepress_newtree');
    error_log("Nonce check passed");

    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    error_log("Using table: $trees_table");

    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;

    error_log("Parsed data - tree_id: $tree_id, tree_name: $tree_name");

    if (empty($tree_id) || empty($tree_name)) {
      error_log("Validation failed - empty tree_id or tree_name");
      wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=add&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }

    // Insert new tree
    $insert_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf,
      'lastimportdate' => '1970-01-01 00:00:00',
      'importfilename' => '',
    ];

    error_log("Insert data: " . print_r($insert_data, true));

    $result = $wpdb->insert($trees_table, $insert_data);
    error_log("Insert result: " . ($result === false ? 'FALSE' : $result));

    if ($result === false) {
      $error = $wpdb->last_error;
      error_log('HeritagePress Add Tree DB Error: ' . $error);
      error_log('Last query: ' . $wpdb->last_query);
      wp_die('Database error: ' . esc_html($error));
    }

    error_log("Insert successful, redirecting...");
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree added successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Handle edit tree form submission
   */
  public function handle_edit_tree()
  {
    if (!current_user_can('manage_options')) {
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }
    check_admin_referer('heritagepress_edittree');
    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    $original_tree_id = isset($_POST['original_tree_id']) ? sanitize_text_field($_POST['original_tree_id']) : '';
    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;
    if (empty($tree_id) || empty($tree_name)) {
      wp_redirect(admin_url('admin.php?page=heritagepress-edittree&tree=' . urlencode($original_tree_id) . '&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }
    $update_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf
    ];
    $result = $wpdb->update($trees_table, $update_data, ['gedcom' => $original_tree_id]);
    if ($result === false) {
      $error = $wpdb->last_error;
      wp_die('Database error: ' . esc_html($error));
    }
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree updated successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Initialize admin
   */
  public function init_admin()
  {
    // Load admin dependencies
    $this->load_files();

    // Initialize controllers
    $this->init_controllers();
  }

  /**
   * Load required files
   */
  private function load_files()
  {
    // Load controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-people-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-import-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-export-controller.php';    // Load admin controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-admin-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-branch-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-endpoint.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-entity-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-media-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-source-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-repository-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-user-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-config-controller.php';
    require_once dirname(__FILE__) . '/controllers/class-hp-families-controller.php';

    // Load handlers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-ajax-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-form-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/handlers/class-hp-add-tree-handler.php';
  }

  /**
   * Initialize controllers
   */
  private function init_controllers()
  {
    new HP_People_Controller();
    new HP_Trees_Controller();
    new HP_Import_Controller();
  }

  /**
   * Handle export request
   */
  public function handle_export_request()
  {
    $export_controller = new HP_Export_Controller();
    $export_controller->handle_export_request();
  }

  /**
   * Handle add tree form submission
   */
  public function handle_add_tree()
  {
    error_log("=== HeritagePress Add Tree Handler Called (Class Method) ===");
    error_log("POST data: " . print_r($_POST, true));

    if (!current_user_can('manage_options')) {
      error_log("Permission check failed");
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }

    check_admin_referer('heritagepress_newtree');
    error_log("Nonce check passed");

    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    error_log("Using table: $trees_table");

    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;

    error_log("Parsed data - tree_id: $tree_id, tree_name: $tree_name");

    if (empty($tree_id) || empty($tree_name)) {
      error_log("Validation failed - empty tree_id or tree_name");
      wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=add&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }

    // Insert new tree
    $insert_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf,
      'lastimportdate' => '1970-01-01 00:00:00',
      'importfilename' => '',
    ];

    error_log("Insert data: " . print_r($insert_data, true));

    $result = $wpdb->insert($trees_table, $insert_data);
    error_log("Insert result: " . ($result === false ? 'FALSE' : $result));

    if ($result === false) {
      $error = $wpdb->last_error;
      error_log('HeritagePress Add Tree DB Error: ' . $error);
      error_log('Last query: ' . $wpdb->last_query);
      wp_die('Database error: ' . esc_html($error));
    }

    error_log("Insert successful, redirecting...");
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree added successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Handle edit tree form submission
   */
  public function handle_edit_tree()
  {
    if (!current_user_can('manage_options')) {
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }
    check_admin_referer('heritagepress_edittree');
    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    $original_tree_id = isset($_POST['original_tree_id']) ? sanitize_text_field($_POST['original_tree_id']) : '';
    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;
    if (empty($tree_id) || empty($tree_name)) {
      wp_redirect(admin_url('admin.php?page=heritagepress-edittree&tree=' . urlencode($original_tree_id) . '&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }
    $update_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf
    ];
    $result = $wpdb->update($trees_table, $update_data, ['gedcom' => $original_tree_id]);
    if ($result === false) {
      $error = $wpdb->last_error;
      wp_die('Database error: ' . esc_html($error));
    }
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree updated successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Initialize admin
   */
  public function init_admin()
  {
    // Load admin dependencies
    $this->load_files();

    // Initialize controllers
    $this->init_controllers();
  }

  /**
   * Load required files
   */
  private function load_files()
  {
    // Load controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-people-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-import-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-export-controller.php';    // Load admin controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-admin-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-branch-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-endpoint.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-entity-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-media-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-source-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-repository-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-user-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-config-controller.php';
    require_once dirname(__FILE__) . '/controllers/class-hp-families-controller.php';

    // Load handlers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-ajax-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-form-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/handlers/class-hp-add-tree-handler.php';
  }

  /**
   * Initialize controllers
   */
  private function init_controllers()
  {
    new HP_People_Controller();
    new HP_Trees_Controller();
    new HP_Import_Controller();
  }

  /**
   * Handle export request
   */
  public function handle_export_request()
  {
    $export_controller = new HP_Export_Controller();
    $export_controller->handle_export_request();
  }

  /**
   * Handle add tree form submission
   */
  public function handle_add_tree()
  {
    error_log("=== HeritagePress Add Tree Handler Called (Class Method) ===");
    error_log("POST data: " . print_r($_POST, true));

    if (!current_user_can('manage_options')) {
      error_log("Permission check failed");
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }

    check_admin_referer('heritagepress_newtree');
    error_log("Nonce check passed");

    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    error_log("Using table: $trees_table");

    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;

    error_log("Parsed data - tree_id: $tree_id, tree_name: $tree_name");

    if (empty($tree_id) || empty($tree_name)) {
      error_log("Validation failed - empty tree_id or tree_name");
      wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=add&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }

    // Insert new tree
    $insert_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf,
      'lastimportdate' => '1970-01-01 00:00:00',
      'importfilename' => '',
    ];

    error_log("Insert data: " . print_r($insert_data, true));

    $result = $wpdb->insert($trees_table, $insert_data);
    error_log("Insert result: " . ($result === false ? 'FALSE' : $result));

    if ($result === false) {
      $error = $wpdb->last_error;
      error_log('HeritagePress Add Tree DB Error: ' . $error);
      error_log('Last query: ' . $wpdb->last_query);
      wp_die('Database error: ' . esc_html($error));
    }

    error_log("Insert successful, redirecting...");
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree added successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Handle edit tree form submission
   */
  public function handle_edit_tree()
  {
    if (!current_user_can('manage_options')) {
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }
    check_admin_referer('heritagepress_edittree');
    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    $original_tree_id = isset($_POST['original_tree_id']) ? sanitize_text_field($_POST['original_tree_id']) : '';
    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;
    if (empty($tree_id) || empty($tree_name)) {
      wp_redirect(admin_url('admin.php?page=heritagepress-edittree&tree=' . urlencode($original_tree_id) . '&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }
    $update_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf
    ];
    $result = $wpdb->update($trees_table, $update_data, ['gedcom' => $original_tree_id]);
    if ($result === false) {
      $error = $wpdb->last_error;
      wp_die('Database error: ' . esc_html($error));
    }
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree updated successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Initialize admin
   */
  public function init_admin()
  {
    // Load admin dependencies
    $this->load_files();

    // Initialize controllers
    $this->init_controllers();
  }

  /**
   * Load required files
   */
  private function load_files()
  {
    // Load controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-people-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-import-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-export-controller.php';    // Load admin controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-admin-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-branch-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-endpoint.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-entity-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-media-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-source-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-repository-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-user-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-config-controller.php';
    require_once dirname(__FILE__) . '/controllers/class-hp-families-controller.php';

    // Load handlers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-ajax-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-form-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/handlers/class-hp-add-tree-handler.php';
  }

  /**
   * Initialize controllers
   */
  private function init_controllers()
  {
    new HP_People_Controller();
    new HP_Trees_Controller();
    new HP_Import_Controller();
  }

  /**
   * Handle export request
   */
  public function handle_export_request()
  {
    $export_controller = new HP_Export_Controller();
    $export_controller->handle_export_request();
  }

  /**
   * Handle add tree form submission
   */
  public function handle_add_tree()
  {
    error_log("=== HeritagePress Add Tree Handler Called (Class Method) ===");
    error_log("POST data: " . print_r($_POST, true));

    if (!current_user_can('manage_options')) {
      error_log("Permission check failed");
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }

    check_admin_referer('heritagepress_newtree');
    error_log("Nonce check passed");

    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    error_log("Using table: $trees_table");

    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;

    error_log("Parsed data - tree_id: $tree_id, tree_name: $tree_name");

    if (empty($tree_id) || empty($tree_name)) {
      error_log("Validation failed - empty tree_id or tree_name");
      wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=add&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }

    // Insert new tree
    $insert_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf,
      'lastimportdate' => '1970-01-01 00:00:00',
      'importfilename' => '',
    ];

    error_log("Insert data: " . print_r($insert_data, true));

    $result = $wpdb->insert($trees_table, $insert_data);
    error_log("Insert result: " . ($result === false ? 'FALSE' : $result));

    if ($result === false) {
      $error = $wpdb->last_error;
      error_log('HeritagePress Add Tree DB Error: ' . $error);
      error_log('Last query: ' . $wpdb->last_query);
      wp_die('Database error: ' . esc_html($error));
    }

    error_log("Insert successful, redirecting...");
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree added successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Handle edit tree form submission
   */
  public function handle_edit_tree()
  {
    if (!current_user_can('manage_options')) {
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }
    check_admin_referer('heritagepress_edittree');
    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    $original_tree_id = isset($_POST['original_tree_id']) ? sanitize_text_field($_POST['original_tree_id']) : '';
    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;
    if (empty($tree_id) || empty($tree_name)) {
      wp_redirect(admin_url('admin.php?page=heritagepress-edittree&tree=' . urlencode($original_tree_id) . '&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }
    $update_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf
    ];
    $result = $wpdb->update($trees_table, $update_data, ['gedcom' => $original_tree_id]);
    if ($result === false) {
      $error = $wpdb->last_error;
      wp_die('Database error: ' . esc_html($error));
    }
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree updated successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Initialize admin
   */
  public function init_admin()
  {
    // Load admin dependencies
    $this->load_files();

    // Initialize controllers
    $this->init_controllers();
  }

  /**
   * Load required files
   */
  private function load_files()
  {
    // Load controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-people-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-import-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-export-controller.php';    // Load admin controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-admin-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-branch-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-endpoint.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-entity-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-media-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-source-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-repository-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-user-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-config-controller.php';
    require_once dirname(__FILE__) . '/controllers/class-hp-families-controller.php';

    // Load handlers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-ajax-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-form-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/handlers/class-hp-add-tree-handler.php';
  }

  /**
   * Initialize controllers
   */
  private function init_controllers()
  {
    new HP_People_Controller();
    new HP_Trees_Controller();
    new HP_Import_Controller();
  }

  /**
   * Handle export request
   */
  public function handle_export_request()
  {
    $export_controller = new HP_Export_Controller();
    $export_controller->handle_export_request();
  }

  /**
   * Handle add tree form submission
   */
  public function handle_add_tree()
  {
    error_log("=== HeritagePress Add Tree Handler Called (Class Method) ===");
    error_log("POST data: " . print_r($_POST, true));

    if (!current_user_can('manage_options')) {
      error_log("Permission check failed");
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }

    check_admin_referer('heritagepress_newtree');
    error_log("Nonce check passed");

    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    error_log("Using table: $trees_table");

    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;

    error_log("Parsed data - tree_id: $tree_id, tree_name: $tree_name");

    if (empty($tree_id) || empty($tree_name)) {
      error_log("Validation failed - empty tree_id or tree_name");
      wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=add&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }

    // Insert new tree
    $insert_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf,
      'lastimportdate' => '1970-01-01 00:00:00',
      'importfilename' => '',
    ];

    error_log("Insert data: " . print_r($insert_data, true));

    $result = $wpdb->insert($trees_table, $insert_data);
    error_log("Insert result: " . ($result === false ? 'FALSE' : $result));

    if ($result === false) {
      $error = $wpdb->last_error;
      error_log('HeritagePress Add Tree DB Error: ' . $error);
      error_log('Last query: ' . $wpdb->last_query);
      wp_die('Database error: ' . esc_html($error));
    }

    error_log("Insert successful, redirecting...");
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree added successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Handle edit tree form submission
   */
  public function handle_edit_tree()
  {
    if (!current_user_can('manage_options')) {
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }
    check_admin_referer('heritagepress_edittree');
    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    $original_tree_id = isset($_POST['original_tree_id']) ? sanitize_text_field($_POST['original_tree_id']) : '';
    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;
    if (empty($tree_id) || empty($tree_name)) {
      wp_redirect(admin_url('admin.php?page=heritagepress-edittree&tree=' . urlencode($original_tree_id) . '&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }
    $update_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf
    ];
    $result = $wpdb->update($trees_table, $update_data, ['gedcom' => $original_tree_id]);
    if ($result === false) {
      $error = $wpdb->last_error;
      wp_die('Database error: ' . esc_html($error));
    }
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree updated successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Initialize admin
   */
  public function init_admin()
  {
    // Load admin dependencies
    $this->load_files();

    // Initialize controllers
    $this->init_controllers();
  }

  /**
   * Load required files
   */
  private function load_files()
  {
    // Load controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-people-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-import-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-export-controller.php';    // Load admin controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-admin-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-branch-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-endpoint.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-entity-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-media-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-source-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-repository-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-user-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-config-controller.php';
    require_once dirname(__FILE__) . '/controllers/class-hp-families-controller.php';

    // Load handlers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-ajax-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-form-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/handlers/class-hp-add-tree-handler.php';
  }

  /**
   * Initialize controllers
   */
  private function init_controllers()
  {
    new HP_People_Controller();
    new HP_Trees_Controller();
    new HP_Import_Controller();
  }

  /**
   * Handle export request
   */
  public function handle_export_request()
  {
    $export_controller = new HP_Export_Controller();
    $export_controller->handle_export_request();
  }

  /**
   * Handle add tree form submission
   */
  public function handle_add_tree()
  {
    error_log("=== HeritagePress Add Tree Handler Called (Class Method) ===");
    error_log("POST data: " . print_r($_POST, true));

    if (!current_user_can('manage_options')) {
      error_log("Permission check failed");
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }

    check_admin_referer('heritagepress_newtree');
    error_log("Nonce check passed");

    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    error_log("Using table: $trees_table");

    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;

    error_log("Parsed data - tree_id: $tree_id, tree_name: $tree_name");

    if (empty($tree_id) || empty($tree_name)) {
      error_log("Validation failed - empty tree_id or tree_name");
      wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=add&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }

    // Insert new tree
    $insert_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf,
      'lastimportdate' => '1970-01-01 00:00:00',
      'importfilename' => '',
    ];

    error_log("Insert data: " . print_r($insert_data, true));

    $result = $wpdb->insert($trees_table, $insert_data);
    error_log("Insert result: " . ($result === false ? 'FALSE' : $result));

    if ($result === false) {
      $error = $wpdb->last_error;
      error_log('HeritagePress Add Tree DB Error: ' . $error);
      error_log('Last query: ' . $wpdb->last_query);
      wp_die('Database error: ' . esc_html($error));
    }

    error_log("Insert successful, redirecting...");
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree added successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Handle edit tree form submission
   */
  public function handle_edit_tree()
  {
    if (!current_user_can('manage_options')) {
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }
    check_admin_referer('heritagepress_edittree');
    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    $original_tree_id = isset($_POST['original_tree_id']) ? sanitize_text_field($_POST['original_tree_id']) : '';
    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;
    if (empty($tree_id) || empty($tree_name)) {
      wp_redirect(admin_url('admin.php?page=heritagepress-edittree&tree=' . urlencode($original_tree_id) . '&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }
    $update_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf
    ];
    $result = $wpdb->update($trees_table, $update_data, ['gedcom' => $original_tree_id]);
    if ($result === false) {
      $error = $wpdb->last_error;
      wp_die('Database error: ' . esc_html($error));
    }
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree updated successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Initialize admin
   */
  public function init_admin()
  {
    // Load admin dependencies
    $this->load_files();

    // Initialize controllers
    $this->init_controllers();
  }

  /**
   * Load required files
   */
  private function load_files()
  {
    // Load controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-people-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-import-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-export-controller.php';    // Load admin controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-admin-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-branch-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-endpoint.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-entity-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-media-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-source-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-repository-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-user-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-config-controller.php';
    require_once dirname(__FILE__) . '/controllers/class-hp-families-controller.php';

    // Load handlers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-ajax-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-form-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/handlers/class-hp-add-tree-handler.php';
  }

  /**
   * Initialize controllers
   */
  private function init_controllers()
  {
    new HP_People_Controller();
    new HP_Trees_Controller();
    new HP_Import_Controller();
  }

  /**
   * Handle export request
   */
  public function handle_export_request()
  {
    $export_controller = new HP_Export_Controller();
    $export_controller->handle_export_request();
  }

  /**
   * Handle add tree form submission
   */
  public function handle_add_tree()
  {
    error_log("=== HeritagePress Add Tree Handler Called (Class Method) ===");
    error_log("POST data: " . print_r($_POST, true));

    if (!current_user_can('manage_options')) {
      error_log("Permission check failed");
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }

    check_admin_referer('heritagepress_newtree');
    error_log("Nonce check passed");

    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    error_log("Using table: $trees_table");

    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;

    error_log("Parsed data - tree_id: $tree_id, tree_name: $tree_name");

    if (empty($tree_id) || empty($tree_name)) {
      error_log("Validation failed - empty tree_id or tree_name");
      wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=add&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }

    // Insert new tree
    $insert_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf,
      'lastimportdate' => '1970-01-01 00:00:00',
      'importfilename' => '',
    ];

    error_log("Insert data: " . print_r($insert_data, true));

    $result = $wpdb->insert($trees_table, $insert_data);
    error_log("Insert result: " . ($result === false ? 'FALSE' : $result));

    if ($result === false) {
      $error = $wpdb->last_error;
      error_log('HeritagePress Add Tree DB Error: ' . $error);
      error_log('Last query: ' . $wpdb->last_query);
      wp_die('Database error: ' . esc_html($error));
    }

    error_log("Insert successful, redirecting...");
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree added successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Handle edit tree form submission
   */
  public function handle_edit_tree()
  {
    if (!current_user_can('manage_options')) {
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }
    check_admin_referer('heritagepress_edittree');
    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    $original_tree_id = isset($_POST['original_tree_id']) ? sanitize_text_field($_POST['original_tree_id']) : '';
    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;
    if (empty($tree_id) || empty($tree_name)) {
      wp_redirect(admin_url('admin.php?page=heritagepress-edittree&tree=' . urlencode($original_tree_id) . '&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }
    $update_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf
    ];
    $result = $wpdb->update($trees_table, $update_data, ['gedcom' => $original_tree_id]);
    if ($result === false) {
      $error = $wpdb->last_error;
      wp_die('Database error: ' . esc_html($error));
    }
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree updated successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Initialize admin
   */
  public function init_admin()
  {
    // Load admin dependencies
    $this->load_files();

    // Initialize controllers
    $this->init_controllers();
  }

  /**
   * Load required files
   */
  private function load_files()
  {
    // Load controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-people-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-import-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/controllers/class-hp-export-controller.php';    // Load admin controllers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-admin-trees-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-branch-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-id-checker-endpoint.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-entity-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-media-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-source-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-repository-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-user-controller.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/controllers/class-hp-config-controller.php';
    require_once dirname(__FILE__) . '/controllers/class-hp-families-controller.php';

    // Load handlers
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-ajax-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'includes/handlers/class-hp-form-handler.php';
    require_once HERITAGEPRESS_PLUGIN_DIR . 'admin/handlers/class-hp-add-tree-handler.php';
  }

  /**
   * Initialize controllers
   */
  private function init_controllers()
  {
    new HP_People_Controller();
    new HP_Trees_Controller();
    new HP_Import_Controller();
  }

  /**
   * Handle export request
   */
  public function handle_export_request()
  {
    $export_controller = new HP_Export_Controller();
    $export_controller->handle_export_request();
  }

  /**
   * Handle add tree form submission
   */
  public function handle_add_tree()
  {
    error_log("=== HeritagePress Add Tree Handler Called (Class Method) ===");
    error_log("POST data: " . print_r($_POST, true));

    if (!current_user_can('manage_options')) {
      error_log("Permission check failed");
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }

    check_admin_referer('heritagepress_newtree');
    error_log("Nonce check passed");

    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    error_log("Using table: $trees_table");

    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;

    error_log("Parsed data - tree_id: $tree_id, tree_name: $tree_name");

    if (empty($tree_id) || empty($tree_name)) {
      error_log("Validation failed - empty tree_id or tree_name");
      wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=add&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }

    // Insert new tree
    $insert_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf,
      'lastimportdate' => '1970-01-01 00:00:00',
      'importfilename' => '',
    ];

    error_log("Insert data: " . print_r($insert_data, true));

    $result = $wpdb->insert($trees_table, $insert_data);
    error_log("Insert result: " . ($result === false ? 'FALSE' : $result));

    if ($result === false) {
      $error = $wpdb->last_error;
      error_log('HeritagePress Add Tree DB Error: ' . $error);
      error_log('Last query: ' . $wpdb->last_query);
      wp_die('Database error: ' . esc_html($error));
    }

    error_log("Insert successful, redirecting...");
    wp_redirect(admin_url('admin.php?page=heritagepress-trees&tab=browse&message=' . urlencode(__('Tree added successfully.', 'heritagepress'))));
    exit;
  }

  /**
   * Handle edit tree form submission
   */
  public function handle_edit_tree()
  {
    if (!current_user_can('manage_options')) {
      wp_die(__('You do not have sufficient permissions to access this page.', 'heritagepress'));
    }
    check_admin_referer('heritagepress_edittree');
    global $wpdb;
    $trees_table = $wpdb->prefix . 'hp_trees';
    $original_tree_id = isset($_POST['original_tree_id']) ? sanitize_text_field($_POST['original_tree_id']) : '';
    $tree_id = isset($_POST['tree_id']) ? sanitize_text_field($_POST['tree_id']) : '';
    $tree_name = isset($_POST['tree_name']) ? sanitize_text_field($_POST['tree_name']) : '';
    $description = isset($_POST['description']) ? sanitize_textarea_field($_POST['description']) : '';
    $owner = isset($_POST['owner']) ? sanitize_text_field($_POST['owner']) : '';
    $email = isset($_POST['email']) ? sanitize_email($_POST['email']) : '';
    $address = isset($_POST['address']) ? sanitize_text_field($_POST['address']) : '';
    $city = isset($_POST['city']) ? sanitize_text_field($_POST['city']) : '';
    $state = isset($_POST['state']) ? sanitize_text_field($_POST['state']) : '';
    $zip = isset($_POST['zip']) ? sanitize_text_field($_POST['zip']) : '';
    $country = isset($_POST['country']) ? sanitize_text_field($_POST['country']) : '';
    $phone = isset($_POST['phone']) ? sanitize_text_field($_POST['phone']) : '';
    $private = isset($_POST['private']) ? 1 : 0;
    $disallowgedcreate = isset($_POST['disallowgedcreate']) ? 1 : 0;
    $disallowpdf = isset($_POST['disallowpdf']) ? 1 : 0;
    if (empty($tree_id) || empty($tree_name)) {
      wp_redirect(admin_url('admin.php?page=heritagepress-edittree&tree=' . urlencode($original_tree_id) . '&message=' . urlencode(__('Tree ID and Tree Name are required.', 'heritagepress'))));
      exit;
    }
    $update_data = [
      'gedcom' => $tree_id,
      'treename' => $tree_name,
      'description' => $description,
      'owner' => $owner,
      'email' => $email,
      'address' => $address,
      'city' => $city,
      'state' => $state,
      'zip' => $zip,
      'country' => $country,
      'phone' => $phone,
      'secret' => $private,
      'disallowgedcreate' => $disallowgedcreate,
      'disallowpdf' => $disallowpdf
    ];
    $result = $wpdb->update($trees_table, $update_data, ['gedcom' => $original_tree_id]);
   